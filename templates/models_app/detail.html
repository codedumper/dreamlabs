{% extends "base.html" %}
{% load models_extras %}

{% block title %}{{ model.full_name }} - Dreamslabs Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-person"></i> {{ model.full_name }}</h1>
            <div>
                <a href="{% url 'models_app:list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                {% if user.is_superuser or user.role.name == 'GENERAL_MANAGER' or user.role.name == 'REGIONAL_MANAGER' and model.agency == user.agency %}
                <a href="{% url 'models_app:update' model.id %}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Editar
                </a>
                {% if model.is_active_by_dates %}
                <a href="{% url 'models_app:deactivate' model.id %}" class="btn btn-danger">
                    <i class="bi bi-x-circle"></i> Desactivar
                </a>
                {% else %}
                <form method="post" action="{% url 'models_app:reactivate' model.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success" onclick="return confirm('¿Está seguro de reactivar este modelo?')">
                        <i class="bi bi-check-circle"></i> Reactivar
                    </button>
                </form>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% comment %}Section 1: Informations du Modèle{% endcomment %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Personal</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="40%">Nombre:</th>
                        <td>{{ model.first_name }}</td>
                    </tr>
                    <tr>
                        <th>Apellido:</th>
                        <td>{{ model.last_name }}</td>
                    </tr>
                    {% if model.email %}
                    <tr>
                        <th>Email:</th>
                        <td><a href="mailto:{{ model.email }}">{{ model.email }}</a></td>
                    </tr>
                    {% endif %}
                    {% if model.phone %}
                    <tr>
                        <th>Teléfono:</th>
                        <td><a href="tel:{{ model.phone }}">{{ model.phone }}</a></td>
                    </tr>
                    {% endif %}
                    {% if model.cedula %}
                    <tr>
                        <th>Cédula:</th>
                        <td>{{ model.cedula }}</td>
                    </tr>
                    {% endif %}
                    {% if model.edad %}
                    <tr>
                        <th>Edad:</th>
                        <td>{{ model.edad }} años</td>
                    </tr>
                    {% endif %}
                    {% if model.eps %}
                    <tr>
                        <th>EPS:</th>
                        <td>{{ model.get_eps_display }}</td>
                    </tr>
                    {% endif %}
                    {% if model.security_contact_name or model.security_contact_phone %}
                    <tr>
                        <th>Contacto de Seguridad:</th>
                        <td>
                            {% if model.security_contact_name %}{{ model.security_contact_name }}{% endif %}
                            {% if model.security_contact_phone %}
                                {% if model.security_contact_name %}<br>{% endif %}
                                <a href="tel:{{ model.security_contact_phone }}">{{ model.security_contact_phone }}</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Estado:</th>
                        <td>
                            {% if model.is_active_by_dates %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactivo</span>
                            {% endif %}
                            {% if model.status == 'ACTIVE' and not model.is_active_by_dates %}
                            <br><small class="text-muted">(Fuera del período activo: fecha de ingreso o retiro)</small>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        {% if model.user %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Cuenta de Usuario</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="40%">Usuario:</th>
                        <td><strong>{{ model.user.username }}</strong></td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>{{ model.user.email|default:"No especificado" }}</td>
                    </tr>
                    {% if user.is_superuser or user.role.name == 'GENERAL_MANAGER' or user.role.name == 'REGIONAL_MANAGER' %}
                    <tr>
                        <th>Contraseña:</th>
                        <td>
                            {% if user_password_temp %}
                            <div class="alert alert-success mb-2">
                                <i class="bi bi-key"></i> <strong>Nueva Contraseña Generada:</strong>
                                <div class="input-group mt-2" style="max-width: 400px;">
                                    <input type="text" class="form-control bg-light fw-bold" id="user-password-display" value="{{ user_password_temp }}" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyPassword()" title="Copiar">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1">Guarde esta contraseña. No se mostrará nuevamente.</small>
                            </div>
                            {% else %}
                            <div class="input-group" style="max-width: 400px;">
                                <input type="password" class="form-control" id="user-password-display" value="••••••••••••" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="toggle-user-password" onclick="toggleUserPassword()">
                                    <i class="bi bi-eye" id="user-password-icon"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <a href="{% url 'models_app:model_user_reset_password' model.id %}" class="btn btn-sm btn-warning" onclick="return confirm('¿Está seguro de restablecer la contraseña? Se generará una nueva contraseña aleatoria.')">
                                    <i class="bi bi-arrow-clockwise"></i> Restablecer Contraseña
                                </a>
                            </div>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-info-circle"></i> La contraseña está encriptada y no se puede recuperar. Use el botón para generar una nueva.
                            </small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Estado:</th>
                        <td>
                            <span class="badge bg-{% if model.user.is_active %}success{% else %}secondary{% endif %}">
                                {% if model.user.is_active %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </td>
                    </tr>
                </table>
                <span class="badge bg-info mt-2">El modelo puede iniciar sesión para consultar sus datos</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-building"></i> Información de la Agencia</h5>
            </div>
            <div class="card-body">
                <p><strong>Agencia:</strong> <a href="{% url 'agencies:detail' model.agency.id %}">{{ model.agency.name }}</a></p>
                <p><strong>Código:</strong> {{ model.agency.code }}</p>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-laptop"></i> Plataforma</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th width="40%">Plataforma:</th>
                        <td><span class="badge bg-secondary">{{ model.get_platform_display }}</span></td>
                    </tr>
                    {% if user.is_superuser or user.role.name == 'GENERAL_MANAGER' or user.role.name == 'REGIONAL_MANAGER' %}
                    {% if model.password %}
                    <tr>
                        <th>Contraseña:</th>
                        <td>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="password" class="form-control" id="password-display" value="{{ model.password }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="toggle-password" onclick="togglePassword()">
                                    <i class="bi bi-eye" id="password-icon"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endif %}
                </table>
            </div>
        </div>

        {% if model.referred_by or model.referred_models.exists %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people"></i> Referencias</h5>
            </div>
            <div class="card-body">
                {% if model.referred_by %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2"><i class="bi bi-arrow-down-circle"></i> Referido por:</h6>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-2 text-primary"></i>
                        <a href="{% url 'models_app:detail' model.referred_by.id %}" class="text-decoration-none">
                            <strong>{{ model.referred_by.full_name }}</strong>
                        </a>
                        {% if model.referred_by.email %}
                        <small class="text-muted ms-2">({{ model.referred_by.email }})</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if model.referred_models.exists %}
                <div>
                    <h6 class="text-muted mb-2"><i class="bi bi-arrow-up-circle"></i> Modelos referidos por este modelo:</h6>
                    <div class="list-group">
                        {% for referred_model in model.referred_models.all %}
                        <a href="{% url 'models_app:detail' referred_model.id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-person-circle me-2 text-primary"></i>
                                    <strong>{{ referred_model.full_name }}</strong>
                                    {% if referred_model.email %}
                                    <br><small class="text-muted ms-4">{{ referred_model.email }}</small>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if referred_model.is_active_by_dates %}
                                    <span class="badge bg-success">Activo</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Total: {{ model.referred_models.count }} modelo(s) referido(s)
                        </small>
                    </div>
                </div>
                {% endif %}
                
                {% if not model.referred_by and not model.referred_models.exists %}
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle"></i> No hay referencias asociadas a este modelo.
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar"></i> Información de Fechas</h5>
            </div>
            <div class="card-body">
                <p><strong>Fecha de Ingreso:</strong> {{ model.fecha_ingreso|date:"d/m/Y" }}</p>
                {% if model.fecha_retiro %}
                <p><strong>Fecha de Retiro:</strong> {{ model.fecha_retiro|date:"d/m/Y" }}</p>
                {% endif %}
                <hr>
                <p class="mb-1"><strong>Última actualización:</strong> {{ model.updated_at|date:"d/m/Y H:i" }}</p>
                {% if model.deactivated_at %}
                <p class="mb-0"><strong>Fecha de desactivación:</strong> {{ model.deactivated_at|date:"d/m/Y H:i" }}</p>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Horarios Asignados</h5>
            </div>
            <div class="card-body">
                {% if assignments %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Horario</th>
                                <th>Días</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td>
                                    <strong>{{ assignment.schedule.name }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {{ assignment.schedule.start_time|time:"H:i" }} - {{ assignment.schedule.end_time|time:"H:i" }}
                                    </small>
                                </td>
                                <td>
                                    {% if assignment.schedule.week_days %}
                                    <small>{{ assignment.schedule.get_week_days_display }}</small>
                                    {% else %}
                                    <span class="badge bg-secondary">Todos</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{% if assignment.is_active %}success{% else %}secondary{% endif %}">
                                        {% if assignment.is_active %}Activo{% else %}Inactivo{% endif %}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center mb-0">
                    <i class="bi bi-info-circle"></i> No hay horarios asignados.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        {% comment %}Graphique Gauge - Salario Promedio et Jalons de Bonus{% endcomment %}
        {% if biweekly_bonus_rules %}
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-speedometer2"></i> Salario Promedio y Jalones de Bonus</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-sm mb-3" role="alert">
                    <i class="bi bi-info-circle"></i>
                    <small><strong>Quincena actual:</strong> {{ quincena_start|date:"d/m/Y" }} - {{ quincena_end|date:"d/m/Y" }}<br>
                    <strong>Días trabajados según horario:</strong> {{ worked_days_quincena }}<br>
                    <strong>Promedio journalier (USD):</strong> Suma de ganancias USD / {{ worked_days_quincena }} días trabajados</small>
                </div>
                <div class="text-center mb-3" style="position: relative; min-height: 300px;">
                    <div id="gaugeChart" style="width: 100%; height: 280px; margin: 0 auto;"></div>
                    {% if not bonus_milestones %}
                    <div class="alert alert-warning mt-2">
                        <small>Aucun jalon trouvé. Vérifiez que les règles de bonus quinzaines sont bien configurées.</small>
                    </div>
                    {% endif %}
                </div>
                <div class="text-center">
                    <h5 class="mb-1">
                        <span class="badge bg-primary">${{ avg_daily_gain_usd|floatformat:2|default:"0.00" }} USD</span>
                        {% if avg_daily_gain_cop > 0 %}
                        <span class="badge bg-info">${{ avg_daily_gain_cop|floatformat:0 }} COP</span>
                        {% endif %}
                    </h5>
                    <small class="text-muted">Promedio journalier de la quincena (USD)</small>
                    <br><small class="text-muted">({{ worked_days_quincena }} días trabajados según horario)</small>
                </div>
                {% if bonus_milestones %}
                <hr>
                <div class="small">
                    <strong>Jalones de Bonus (Quincena):</strong>
                    <ul class="list-unstyled mb-0 mt-2">
                        {% for milestone in bonus_milestones %}
                        <li class="mb-1">
                            <span class="badge bg-secondary" style="font-size: 0.7rem;">
                                {{ milestone.order }}. {{ milestone.name }}
                            </span>
                            <br>
                            <small class="text-muted ms-3">
                                ${{ milestone.value|floatformat:2 }} {{ milestone.currency }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> Solo se muestran las reglas de bonus quincenales. Los valores también se muestran directamente en el gráfico.
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% comment %}Filtres de date - Nouvelle ligne sur 3 colonnes{% endcomment %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros de Sesiones</h6>
            </div>
            <div class="card-body">
                <form method="get" class="mb-0">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="hours_date_from" class="form-label">Desde</label>
                                <input type="date" class="form-control" id="hours_date_from" name="hours_date_from" 
                                       value="{{ hours_date_from|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="hours_date_to" class="form-label">Hasta</label>
                                <input type="date" class="form-control" id="hours_date_to" name="hours_date_to" 
                                       value="{{ hours_date_to|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-funnel"></i> Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if sessions_with_calculations %}
        {% comment %}Résumé des Statistiques{% endcomment %}
        <div class="card border-info mb-3">
            <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="bi bi-clock"></i> Resumen de Horas</h6>
            </div>
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Trabajadas:</small>
                    <span class="badge bg-info">{{ total_worked_hours|hours_to_hhmm }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Presencia:</small>
                    <span class="badge bg-primary">{{ total_presence_hours|hours_to_hhmm }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">Pausa:</small>
                    <span class="badge bg-warning text-dark">{{ total_break_hours|hours_to_hhmm }}</span>
                </div>
            </div>
        </div>

        <div class="card border-success mb-3">
            <div class="card-header bg-success text-white py-2">
                <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Resumen Financiero</h6>
            </div>
            <div class="card-body p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Ganancia Total:</small>
                    <span class="badge bg-success">${{ total_gain|floatformat:0|default:"0" }} COP</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Impuestos:</small>
                    <span class="badge bg-warning text-dark">-${{ total_bank_fees|floatformat:0|default:"0" }} COP</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Multas:</small>
                    <span class="badge bg-danger">-${{ total_multas|floatformat:0|default:"0" }} COP</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Bonus:</small>
                    <span class="badge bg-success">+${{ total_bonus|floatformat:0|default:"0" }} COP</span>
                </div>
                <hr class="my-2">
                <div class="text-center">
                    <small class="text-muted d-block mb-1">Ganancia del Modelo</small>
                    <span class="badge bg-primary fs-6">${{ total_model_ganancia|floatformat:0|default:"0" }} COP</span>
                </div>
            </div>
        </div>

        {% comment %}Indicateurs de moyenne{% endcomment %}
        <div class="card border-info mb-3">
            <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Promedios</h6>
            </div>
            <div class="card-body p-2">
                <div class="mb-2">
                    <small class="text-muted d-block mb-1">Semana Corriente</small>
                    <div class="d-flex gap-1 flex-wrap">
                        <span class="badge bg-success">${{ week_avg_cop|floatformat:0|default:"0" }} COP</span>
                        {% if week_avg_usd > 0 %}
                        <span class="badge bg-primary">${{ week_avg_usd|floatformat:2 }} USD</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block mb-1">Quinzena</small>
                    <div class="d-flex gap-1 flex-wrap">
                        <span class="badge bg-success">${{ quincena_avg_cop|floatformat:0|default:"0" }} COP</span>
                        {% if quincena_avg_usd > 0 %}
                        <span class="badge bg-primary">${{ quincena_avg_usd|floatformat:2 }} USD</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <small class="text-muted d-block mb-1">Mes</small>
                    <div class="d-flex gap-1 flex-wrap">
                        <span class="badge bg-success">${{ month_avg_cop|floatformat:0|default:"0" }} COP</span>
                        {% if month_avg_usd > 0 %}
                        <span class="badge bg-primary">${{ month_avg_usd|floatformat:2 }} USD</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% comment %}Fórmula de cálculo (collapsible){% endcomment %}
        <div class="card border-secondary mb-3">
            <div class="card-header bg-secondary text-white py-2" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#formulaCollapse" aria-expanded="false">
                <h6 class="mb-0 small">
                    <i class="bi bi-info-circle"></i> Fórmula
                    <i class="bi bi-chevron-down float-end"></i>
                </h6>
            </div>
            <div id="formulaCollapse" class="collapse">
                <div class="card-body p-2">
                    <div class="mb-2">
                        <div class="d-flex align-items-center justify-content-center flex-wrap gap-1 mb-1">
                            <span class="badge bg-success small">Ganancia Total</span>
                            <span class="text-muted small">-</span>
                            <span class="badge bg-warning text-dark small">Impuestos</span>
                            <span class="text-muted small">=</span>
                            <span class="badge bg-info small">Ganancia después de Impuestos</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-center flex-wrap gap-1 mb-1">
                            <span class="badge bg-info small">Ganancia después de Impuestos</span>
                            <span class="text-muted small">×</span>
                            <span class="badge bg-secondary small">%GM</span>
                            <span class="text-muted small">=</span>
                            <span class="badge bg-info small">Ganancia con Porcentaje</span>
                        </div>
                        <div class="d-flex align-items-center justify-content-center flex-wrap gap-1">
                            <span class="badge bg-info small">Ganancia con Porcentaje</span>
                            <span class="text-muted small">-</span>
                            <span class="badge bg-danger small">Multas</span>
                            <span class="text-muted small">+</span>
                            <span class="badge bg-success small">Bonus</span>
                            <span class="text-muted small">=</span>
                            <span class="badge bg-primary small"><strong>Ganancia del Modelo</strong></span>
                        </div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">
                                <strong>%GB</strong> = Impuestos |
                            <strong>%GM</strong> = Ganancia del Modelo
                        </small>
                    </div>
                </div>
            </div>
        </div>

        {% comment %}Tableau des sessions{% endcomment %}
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0"><i class="bi bi-list-ul"></i> Sesiones</h6>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="small">Fecha</th>
                                <th class="text-end small">Ganancia</th>
                                <th class="text-end small">Impuestos</th>
                                <th class="text-end small">Multas</th>
                                <th class="text-end small">Bonus</th>
                                <th class="text-end small">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session_data in sessions_with_calculations %}
                            <tr>
                                <td class="small"><strong>{{ session_data.session.date|date:"d/m/Y" }}</strong></td>
                                <td class="text-end small">
                                    {% if session_data.session.session_gain_amount_usd %}
                                    <span class="badge bg-primary" style="font-size: 0.7rem;">
                                        ${{ session_data.session.session_gain_amount_usd|floatformat:2 }} USD
                                    </span>
                                    <br>
                                    {% endif %}
                                    <span class="badge bg-success" style="font-size: 0.7rem;">${{ session_data.gain|floatformat:0|default:"0" }} COP</span>
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-warning text-dark" style="font-size: 0.7rem;">-${{ session_data.bank_fees|floatformat:0|default:"0" }}</span>
                                </td>
                                <td class="text-end small">
                                    {% if session_data.multas > 0 %}
                                    <span class="badge bg-danger" style="font-size: 0.7rem;">-${{ session_data.multas|floatformat:0 }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end small">
                                    {% if session_data.bonus > 0 %}
                                    <span class="badge bg-success" style="font-size: 0.7rem;">+${{ session_data.bonus|floatformat:0 }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-primary" style="font-size: 0.7rem;">${{ session_data.model_ganancia|floatformat:0|default:"0" }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% comment %}Ligne totale{% endcomment %}
                            <tr class="table-info fw-bold">
                                <td class="small"><strong>TOTAL</strong></td>
                                <td class="text-end small">
                                    <span class="badge bg-success">${{ total_gain|floatformat:0|default:"0" }} COP</span>
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-warning text-dark">-${{ total_bank_fees|floatformat:0|default:"0" }}</span>
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-danger">-${{ total_multas|floatformat:0|default:"0" }}</span>
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-success">+${{ total_bonus|floatformat:0|default:"0" }}</span>
                                </td>
                                <td class="text-end small">
                                    <span class="badge bg-primary">${{ total_model_ganancia|floatformat:0|default:"0" }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No hay sesiones completadas registradas para el período seleccionado.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword() {
    const passwordInput = document.getElementById('password-display');
    const passwordIcon = document.getElementById('password-icon');
    
    if (passwordInput && passwordIcon) {
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            passwordIcon.classList.remove('bi-eye');
            passwordIcon.classList.add('bi-eye-slash');
        } else {
            passwordInput.type = 'password';
            passwordIcon.classList.remove('bi-eye-slash');
            passwordIcon.classList.add('bi-eye');
        }
    }
}

function toggleUserPassword() {
    const passwordInput = document.getElementById('user-password-display');
    const passwordIcon = document.getElementById('user-password-icon');
    
    if (passwordInput && passwordIcon) {
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            passwordInput.value = 'No se puede recuperar (encriptada)';
            passwordInput.style.fontStyle = 'italic';
            passwordInput.style.color = '#6c757d';
            passwordIcon.classList.remove('bi-eye');
            passwordIcon.classList.add('bi-eye-slash');
        } else {
            passwordInput.type = 'password';
            passwordInput.value = '••••••••••••';
            passwordInput.style.fontStyle = 'normal';
            passwordInput.style.color = '';
            passwordIcon.classList.remove('bi-eye-slash');
            passwordIcon.classList.add('bi-eye');
        }
    }
}

function copyPassword() {
    const passwordInput = document.getElementById('user-password-display');
    if (passwordInput) {
        passwordInput.select();
        document.execCommand('copy');
        // Feedback visuel
        const btn = event.target.closest('button');
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }
    }
}
</script>

{% if biweekly_bonus_rules %}
<!-- ApexCharts - Bibliothèque moderne et esthétique pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Graphique Gauge ApexCharts pour Salario Promedio
document.addEventListener('DOMContentLoaded', function() {
    try {
        const gaugeDiv = document.getElementById('gaugeChart');
        if (!gaugeDiv) {
            console.error('Gauge chart div not found');
            return;
        }
        
        // Valeur actuelle (moyenne journalière en USD)
        const currentValue = parseFloat('{{ avg_daily_gain_usd|default:0 }}') || 0;
        
        // Récupérer tous les jalons en USD
        const milestones = [
            {% for milestone in bonus_milestones %}
            {
                value: parseFloat('{{ milestone.value }}'),
                name: '{{ milestone.name|escapejs }}',
                order: {{ milestone.order }},
                currency: '{{ milestone.currency|escapejs }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Trier par ordre croissant
        milestones.sort((a, b) => a.value - b.value);
        
        console.log('Gauge Chart - Current value:', currentValue);
        console.log('Gauge Chart - Milestones:', milestones);
        
        // Si aucun jalon, ne pas afficher le graphique
        if (milestones.length === 0) {
            console.warn('No milestones found, hiding gauge');
            gaugeDiv.style.display = 'none';
            return;
        }
        
        // Trouver la valeur maximale pour l'échelle (10% au-dessus du plus haut objectif)
        const maxMilestone = milestones.length > 0 ? Math.max(...milestones.map(m => m.value)) : 0;
        const maxValue = maxMilestone > 0 ? maxMilestone * 1.1 : Math.max(currentValue * 1.5, 1000);
        
        // Valeur minimale de l'échelle
        const minValue = 50;
        
        if (maxValue <= minValue) {
            console.error('Invalid maxValue:', maxValue);
            gaugeDiv.style.display = 'none';
            return;
        }
        
        console.log('Gauge Chart - Min value:', minValue, 'Max value:', maxValue, 'Current value:', currentValue);
        
        // Palette de couleurs pour les segments
        const colorPalette = [
            '#dc3545',  // Rouge
            '#ff9800',  // Orange
            '#ffa726',  // Orange/Jaune clair
            '#ffc107',  // Jaune
            '#8bc34a',  // Vert clair
            '#4caf50',  // Vert moyen
            '#28a745',  // Vert foncé
            '#1b5e20'   // Vert très foncé
        ];
        
        // Créer les segments colorés pour ApexCharts
        // ApexCharts utilise une fonction pour déterminer la couleur
        const getColorForValue = function(value) {
            // Segment 1: Rouge jusqu'au premier jalon
            if (milestones.length > 0) {
                if (value < milestones[0].value) {
                    return colorPalette[0]; // Rouge
                }
                
                // Segments entre les jalons
                for (let i = 0; i < milestones.length; i++) {
                    const nextValue = i < milestones.length - 1 ? milestones[i + 1].value : maxValue;
                    if (value >= milestones[i].value && value <= nextValue) {
                        const colorIndex = Math.min(i + 1, colorPalette.length - 1);
                        return colorPalette[colorIndex];
                    }
                }
                
                // Si la valeur dépasse tous les segments
                return colorPalette[colorPalette.length - 1];
            } else {
                // Pas de jalons : tout en rouge
                return colorPalette[0];
            }
        };
        
        // Configuration ApexCharts pour gauge radial avec segments colorés
        const options = {
            series: [currentValue],
            chart: {
                height: 280,
                type: 'radialBar',
                offsetY: 0
            },
            plotOptions: {
                radialBar: {
                    startAngle: -90,
                    endAngle: 90,
                    hollow: {
                        margin: 0,
                        size: '70%',
                        background: '#fff',
                        position: 'front',
                        dropShadow: {
                            enabled: true,
                            top: 3,
                            left: 0,
                            blur: 4,
                            opacity: 0.24
                        }
                    },
                    track: {
                        background: '#f1f1f1',
                        strokeWidth: '67%',
                        margin: 0,
                    },
                    dataLabels: {
                        show: true,
                        name: {
                            show: true,
                            fontSize: '16px',
                            fontWeight: 600,
                            offsetY: -10,
                            color: '#333'
                        },
                        value: {
                            show: true,
                            fontSize: '30px',
                            fontWeight: 700,
                            offsetY: 16,
                            color: '#333',
                            formatter: function(val) {
                                return '$' + val.toFixed(2);
                            }
                        }
                    }
                }
            },
            // Utiliser une fonction pour déterminer la couleur selon la valeur
            colors: [
                function({ value, seriesIndex, w }) {
                    // Vérifier que la valeur est valide
                    if (typeof value === 'undefined' || isNaN(value)) {
                        return '#ffc107';
                    }
                    return getColorForValue(value);
                }
            ],
            labels: ['Salario Promedio (USD)'],
            min: minValue,
            max: maxValue
        };
        
        // Ajouter les annotations pour les labels des bonus (si supporté)
        // Note: ApexCharts radialBar ne supporte pas directement les annotations de points
        // On utilisera une approche HTML/CSS pour les labels
        
        // Créer et dessiner le graphique
        const chart = new ApexCharts(gaugeDiv, options);
        chart.render();
        
        // Ajouter les labels des bonus après le rendu du graphique
        if (milestones.length > 0) {
            // Attendre que le graphique soit rendu
            setTimeout(function() {
                const chartContainer = gaugeDiv.parentElement;
                const labelsContainer = document.createElement('div');
                labelsContainer.id = 'gaugeLabels';
                labelsContainer.style.position = 'absolute';
                labelsContainer.style.top = '0';
                labelsContainer.style.left = '0';
                labelsContainer.style.width = '100%';
                labelsContainer.style.height = '280px';
                labelsContainer.style.pointerEvents = 'none';
                labelsContainer.style.zIndex = '10';
                
                milestones.forEach((milestone, index) => {
                    const prevValue = index === 0 ? minValue : milestones[index - 1].value;
                    const midValue = (prevValue + milestone.value) / 2;
                    const normalizedValue = (midValue - minValue) / (maxValue - minValue);
                    // Pour un gauge de -90° à 90°, l'angle va de 0° (gauche) à 180° (droite)
                    const angle = 180 - (normalizedValue * 180);
                    const radius = 100; // Distance du centre (réduite pour éviter le chevauchement)
                    
                    const label = document.createElement('div');
                    label.style.position = 'absolute';
                    label.style.left = '50%';
                    label.style.top = '50%';
                    label.style.transform = `translate(calc(-50% + ${radius * Math.cos(angle * Math.PI / 180)}px), calc(-50% - ${radius * Math.sin(angle * Math.PI / 180)}px))`;
                    label.style.background = 'rgba(255, 255, 255, 0.95)';
                    label.style.border = '1px solid #ddd';
                    label.style.borderRadius = '4px';
                    label.style.padding = '3px 6px';
                    label.style.fontSize = '10px';
                    label.style.fontWeight = 'bold';
                    label.style.color = '#333';
                    label.style.whiteSpace = 'nowrap';
                    label.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    
                    let nameText = milestone.name;
                    if (nameText.length > 18) {
                        nameText = nameText.substring(0, 15) + '...';
                    }
                    label.textContent = nameText;
                    
                    labelsContainer.appendChild(label);
                });
                
                chartContainer.appendChild(labelsContainer);
            }, 200);
        }
        
        console.log('Gauge Chart - ApexCharts drawing completed');
    } catch (error) {
        console.error('Error drawing gauge chart:', error);
        console.error('Error details:', error.stack);
    }
});
</script>
{% endif %}
{% endblock %}
