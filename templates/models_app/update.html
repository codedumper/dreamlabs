{% extends "base.html" %}

{% block title %}Editar Modelo - Dreamslabs Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-pencil"></i> Editar Modelo: {{ model.full_name }}</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    {% if can_edit_agency and agencies|length > 0 %}
                    <div class="mb-3">
                        <label for="agency" class="form-label">Agencia <span class="text-danger">*</span></label>
                        <select class="form-select" id="agency" name="agency" required>
                            {% for ag in agencies %}
                            <option value="{{ ag.id }}" {% if model.agency.id == ag.id %}selected{% endif %}>
                                {{ ag.name }} ({{ ag.code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Agencia:</strong> {{ model.agency.name }} ({{ model.agency.code }})
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ model.first_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Apellido <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ model.last_name }}" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ model.email|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="phone" name="phone" value="{{ model.phone|default:'' }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fecha_ingreso" class="form-label">Fecha de Ingreso <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" value="{{ model.fecha_ingreso|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fecha_retiro" class="form-label">Fecha de Retiro</label>
                            <input type="date" class="form-control" id="fecha_retiro" name="fecha_retiro" value="{% if model.fecha_retiro %}{{ model.fecha_retiro|date:'Y-m-d' }}{% endif %}">
                            <small class="form-text text-muted">Se establecerá automáticamente al desactivar el modelo</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cedula" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedula" name="cedula" value="{{ model.cedula|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edad" class="form-label">Edad</label>
                            <input type="number" class="form-control" id="edad" name="edad" min="0" value="{{ model.edad|default:'' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="eps" class="form-label">EPS</label>
                        <select class="form-select" id="eps" name="eps">
                            <option value="">Seleccionar EPS</option>
                            <option value="NUEVA_EPS" {% if model.eps == 'NUEVA_EPS' %}selected{% endif %}>Nueva EPS</option>
                            <option value="SANITAS" {% if model.eps == 'SANITAS' %}selected{% endif %}>Sanitas</option>
                            <option value="PONAL" {% if model.eps == 'PONAL' %}selected{% endif %}>Ponal</option>
                            <option value="FAMISANAR" {% if model.eps == 'FAMISANAR' %}selected{% endif %}>Famisanar</option>
                            <option value="SALUD_TOTAL" {% if model.eps == 'SALUD_TOTAL' %}selected{% endif %}>Salud Total</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="security_contact_name" class="form-label">Nombre del Contacto de Seguridad</label>
                            <input type="text" class="form-control" id="security_contact_name" name="security_contact_name" value="{{ model.security_contact_name|default:'' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="security_contact_phone" class="form-label">Teléfono del Contacto de Seguridad</label>
                            <input type="text" class="form-control" id="security_contact_phone" name="security_contact_phone" value="{{ model.security_contact_phone|default:'' }}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="referred_by" class="form-label">Referido por</label>
                        <select class="form-select" id="referred_by" name="referred_by">
                            <option value="">Ninguno (opcional)</option>
                            {% for available_model in available_models %}
                            <option value="{{ available_model.id }}" {% if model.referred_by and model.referred_by.id == available_model.id %}selected{% endif %}>
                                {{ available_model.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Seleccione el modelo que refirió a este modelo (opcional).</small>
                    </div>
                    <div class="card border-secondary mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-laptop"></i> Plataforma</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="platform" class="form-label">Plataforma</label>
                                    <select class="form-select" id="platform" name="platform">
                                        <option value="FLIRTIFY" {% if model.platform == 'FLIRTIFY' %}selected{% endif %}>Flirtify</option>
                                    </select>
                                </div>
                                {% if user.is_superuser or user.role.name == 'GENERAL_MANAGER' or user.role.name == 'REGIONAL_MANAGER' %}
                                <div class="col-md-6 mb-3">
                                    <label for="password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="password" name="password" placeholder="Dejar vacío para no cambiar" value="{{ model.password|default:'' }}">
                                    <small class="form-text text-muted">Este campo solo es visible para los managers. Dejar vacío para no cambiar la contraseña.</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    {% if user.is_superuser or user.role.name == 'GENERAL_MANAGER' or user.role.name == 'REGIONAL_MANAGER' %}
                    <div class="card border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-person-badge"></i> Cuenta de Usuario</h6>
                        </div>
                        <div class="card-body">
                            {% if model.user %}
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> <strong>El modelo tiene una cuenta de usuario asociada.</strong>
                                <br>
                                <small>Usuario: <strong>{{ model.user.username }}</strong> | Email: {{ model.user.email|default:"-" }}</small>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="remove_user" name="remove_user">
                                <label class="form-check-label" for="remove_user">
                                    <strong class="text-danger">Eliminar cuenta de usuario</strong>
                                </label>
                                <small class="form-text text-muted d-block">Marcar esta opción eliminará permanentemente la cuenta de usuario asociada al modelo.</small>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> <strong>El modelo no tiene una cuenta de usuario.</strong>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="create_user" value="create">
                                <label class="form-check-label" for="create_user">
                                    <strong class="text-success">Crear cuenta de usuario</strong>
                                </label>
                                <small class="form-text text-muted d-block">Se creará automáticamente un usuario con un nombre de usuario basado en el nombre del modelo y una contraseña aleatoria.</small>
                            </div>
                            <input type="hidden" id="manage_user" name="manage_user" value="">
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'models_app:detail' model.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const createUserCheckbox = document.getElementById('create_user');
    const manageUserHidden = document.getElementById('manage_user');
    
    if (createUserCheckbox) {
        createUserCheckbox.addEventListener('change', function() {
            manageUserHidden.value = this.checked ? 'create' : '';
        });
    }
});
</script>
{% endblock %}
